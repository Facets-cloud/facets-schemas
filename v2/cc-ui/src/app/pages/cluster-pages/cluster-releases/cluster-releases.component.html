<app-layout-one-column>
  <span heading> Cluster Releases </span>
  <span subheading>Explore Release history and frequency. </span>
  <div buttons>
    <button
      nbButton
      status="primary"
      class="mr-3 mb-3"
      size="small"
      (click)="openDeploymentPopupFull(deploymentUIFull)"
    >
      Release
    </button>
    <button
      nbButton
      status="control"
      class="mr-3 mb-3"
      size="small"
      (click)="openDeploymentPopup(deploymentUI)"
    >
      Hotfix Application
    </button>

  </div>

  <div class="row">
    <div class="col-12">
      <nb-card>
        <nb-card-header>
          Last 30 Days
        </nb-card-header>
        <nb-card-body>
          <div class="row">
            <div class=col-3>
              <div class="card-subtitle mb-3">
                Successful Releases
              </div>
              <h3 class="font-weight-light">{{this.stats?.successReleases}}</h3>
            </div>
            <div class=col-3>
              <div class="card-subtitle mb-3">
                Failed Releases
              </div>
              <h3 class="text-danger font-weight-light">{{stats?.failedReleases}}</h3>
            </div>
            <div class=col-3>
              <div class="card-subtitle mb-3"
                   nbTooltip="Deployment frequency looks at how often an you deploy code to this cluster">
                Deployment Frequency
                <nb-icon icon="info-outline"></nb-icon>
              </div>
              <h3 class="font-weight-light">{{this.stats?.successReleases / 30 | number : "1.2-2"}}</h3>

            </div>
            <div class=col-3>
              <div class="card-subtitle mb-3"
                   nbTooltip="Change failure rate is the percentage of changes that resulted in failed releases">
                Change Failure Rate
                <nb-icon icon="info-outline"></nb-icon>
              </div>
              <h3
                class="text-danger font-weight-light">{{stats?.failedReleases / (this.stats?.successReleases + stats?.failedReleases) | percent}}</h3>
            </div>
          </div>

        </nb-card-body>
      </nb-card>
    </div>

  </div>
  <div class="row">
    <div class="col-12">
      <nb-card>
        <nb-card-header>
          <div> Latest Release</div>
        </nb-card-header>
        <nb-card-body>
          <table class="table table-bordered text-left">
            <thead>
            <tr scope=row class="bg-light">
              <th class="vert-center" scope="col">Started</th>
              <th class="vert-center" scope="col">Status</th>
              <th class="vert-center" scope="col">Last Commit
                <nb-icon icon="info-outline"
                         nbTooltip="Last commit id in Stack, which is considered in this release"></nb-icon>
              </th>
              <th class="vert-center" scope="col">Release Type</th>
              <th class="vert-center" scope="col">Triggered By</th>
              <th *ngIf="downStreamClusters.length !== 0" class="vert-center" scope="col">Sign Off</th>
              <th class="vert-center" scope="col">Actions</th>
            </tr>
            <tr scope=row *ngIf="latestRelease">
              <ng-template *ngTemplateOutlet="releaseRow; context: {$implicit: latestRelease}"></ng-template>
            </tr>
            </thead>
          </table>
        </nb-card-body>
      </nb-card>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <nb-card>
        <nb-card-header>
          <div style="float:left;"> Release History</div>
          <div style="float:right;">

            <nb-toggle [(ngModel)]="this.showNoChanges" labelPosition="end"
                       status="primary" class="align-middle">
              Show <span
              class="badge badge-secondary">NO CHANGE</span>
            </nb-toggle>
          </div>
        </nb-card-header>
        <nb-card-body>
          <div class="table-responsive">
            <table class="table table-bordered text-left" *ngIf="!this.showNoChanges">
              <thead>
              <tr scope=row class="bg-light">
                <th class="vert-center" scope="col">Started</th>
                <th class="vert-center" scope="col">Status</th>
                <th class="vert-center" scope="col">Last Commit
                  <nb-icon icon="info-outline"
                           nbTooltip="Last commit id in Stack, which is considered in this release"></nb-icon>
                </th>
                <th class="vert-center" scope="col">Release Type</th>
                <th class="vert-center" scope="col">Triggered By</th>
                <th *ngIf="downStreamClusters.length !== 0" class="vert-center" scope="col">Sign Off</th>
                <th class="vert-center" scope="col">Actions</th>
              </tr>
              <tr scope=row *ngFor="let deployment of deployments">
                <ng-template *ngTemplateOutlet="releaseRow; context: {$implicit: deployment}"></ng-template>
              </tr>
              </thead>
            </table>
            <table class="table table-bordered text-left" *ngIf="this.showNoChanges">
              <thead>
              <tr scope=row class="bg-light">
                <th class="vert-center" scope="col">Started</th>
                <th class="vert-center" scope="col">Status</th>
                <th class="vert-center" scope="col">Last Commit
                  <nb-icon icon="info-outline"
                           nbTooltip="Last commit id in Stack, which is considered in this release"></nb-icon>
                </th>
                <th class="vert-center" scope="col">Release Type</th>
                <th class="vert-center" scope="col">Triggered By</th>
                <th *ngIf="downStreamClusters.length !== 0" class="vert-center" scope="col">Sign Off</th>
                <th class="vert-center" scope="col">Actions</th>
              </tr>
              <tr scope=row *ngFor="let deployment of deploymentsFull">
                <ng-template *ngTemplateOutlet="releaseRow; context: {$implicit: deployment}"></ng-template>
              </tr>
              </thead>
            </table>
          </div>
        </nb-card-body>
      </nb-card>
    </div>
  </div>

</app-layout-one-column>

<ng-template #releaseRow let-deployment>
  <td class="vert-center" scope="col"
  >{{deployment.createdOn | timeago}} <br/>
    <span class="text-muted">{{deployment.createdOn | date: 'short'}}</span></td>
  <td class="vert-center" scope="col" *ngIf="deployment.status == 'IN_PROGRESS'"><span
    class="badge badge-primary">IN PROGRESS</span></td>
  <td class="vert-center" scope="col" *ngIf="deployment.status == 'FAULT'"><span
    class="badge badge-secondary">NO CHANGE</span></td>
  <td class="vert-center" scope="col" *ngIf="deployment.status == 'SUCCEEDED'"><span
    class="badge badge-success">SUCCESS</span></td>
  <td class="vert-center" scope="col" *ngIf="deployment.status == 'FAILED'"><span
    class="badge badge-danger">FAIL</span>
  </td>
  <td class="vert-center" scope="col"
      *ngIf=" -1 == ['FAULT','FAILED','SUCCEEDED','IN_PROGRESS'].indexOf(deployment.status)"><span
    class="badge badge-dark">{{deployment.status}}</span></td>

  <td class="vert-center" scope="col">
    <a href="{{deployment.stackUrl}}" target="_blank">{{deployment.stackVersion | slice:0:7}}</a>
    <button *ngIf="deployment.allowSignoff" (click)="openTab(deployment.compareUrl)" nbButton
            nbTooltip="Compare with signed-off version" ghost status="primary">
      <nb-icon icon="code-outline"></nb-icon>
    </button>
  </td>
  <td class="vert-center" scope="col" *ngIf="deployment.deploymentType == 'REGULAR'">Full Release</td>
  <td class="vert-center" scope="col" *ngIf="deployment.deploymentType == 'CUSTOM'">Hotfix Release</td>
  <td class="vert-center" scope="col" *ngIf="deployment.triggeredBy != 'Deployer'">
    <nb-icon icon="person-outline" class="mr-2"></nb-icon>
    {{deployment.triggeredBy}}</td>
  <td class="vert-center" scope="col" *ngIf="deployment.triggeredBy == 'Deployer'">
    <nb-icon icon="calendar-outline" class="mr-2"></nb-icon>
    Facets Bot
  </td>

  <td *ngIf="downStreamClusters.length !== 0" scope="col"
      class="vert-center">{{deployment.signedOff ? "Signed Off" : deployment.allowSignoff ? "Not Signed Off" : "N/A"}}
  </td>
  <td scope="col" class="text-left">
    <button (click)="showDetails(dialog, deployment.id)" nbButton ghost status="primary"
            nbTooltip="See Release Details" *ngIf="deployment.status != 'FAULT'">
      <nb-icon icon="info-outline"></nb-icon>
    </button>
    <button (click)="showLogDetails(logsDialog, deployment.id, deployment.status)" nbButton ghost
            *ngIf="deployment.status != 'FAULT'"
            status="primary" nbTooltip="See Terraform Logs">
      <nb-icon icon="file-text-outline"></nb-icon>
    </button>

    <button *ngIf="downStreamClusters.length !== 0 && deployment.allowSignoff"
            (click)="confirmSignoff(signoff, deployment)" nbButton ghost
            status="primary" nbTooltip="Sign Off this Stack version?">
      <nb-icon icon="flag-outline"></nb-icon>
    </button>
  </td>
</ng-template>

<ng-template #logsDialog let-data let-ref="dialogRef">
  <nb-card size="giant" class="min-vw-100" [nbSpinner]="logLoading">
    <nb-card-header>
      <span *ngIf="!raw">Logs</span>
      <span *ngIf="raw">Raw Logs</span>
      <nb-checkbox [(ngModel)]="this.raw" class="mx-3 float-right mt-2">See Raw Logs</nb-checkbox>
      <button nbButton status=primary nbTooltip="Fetch latest logs" ghost
              (click)="this.getLogs(data.deploymentId, true)" *ngIf="data.status == 'IN_PROGRESS'" class="float-right">
        <nb-icon icon="refresh"></nb-icon>
        <span class="badge badge-primary" *ngIf="data.status == 'IN_PROGRESS'">IN PROGRESS</span>
      </button>
    </nb-card-header>
    <nb-card-body class="bg-dark text-white">
      <nb-list nbInfiniteList [threshold]="500">
        <nb-list-item *ngFor="let log of this.logLines | keyvalue" class="bg-dark text-white border-0">
          <span class="badge badge-dark text-light mr-3">{{log.value.timestamp | date: 'short'}} ></span>
          <div [innerHTML]="convert.toHtml(log.value.message) | safeHtml" *ngIf="!this.raw"></div>
          <span class="badge badge-dark text-white" *ngIf="this.raw"
          >{{ log.value.message }}</span>
        </nb-list-item>
      </nb-list>
      <button *ngIf="!logLoading" nbButton status=basic fullWidth (click)="this.getLogs(data.deploymentId, false)"
              class="ml-3">Load More
      </button>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #signoff let-data let-ref="dialogRef">
  <nb-card size=medium>
    <nb-card-header>Sign-off stack version {{data.stackVersion | slice:0:7}}?</nb-card-header>
    <nb-card-body>
      <div class="mb-3">
        This stack version will be deployed to the following clusters in the next release cycle:
      </div>
      <div>
        <nb-list>
          <nb-list-item *ngFor="let item of downStreamClusters">
            {{item}}
          </nb-list-item>
        </nb-list>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <button nbButton status=primary (click)="ref.close(data)">Confirm</button>
      <button class='ml-3' nbButton status=basic (click)="ref.close()">Cancel</button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<ng-template #dialog let-data let-ref="dialogRef">
  <nb-card size=giant>
    <nb-card-header>Release Details</nb-card-header>
    <nb-card-body>
      <nb-tabset>
        <nb-tab tabTitle="Applications Deployed">
          <div class="table-responsive">
            <table class="table table-bordered">
              <tr class="bg-light">
                <th class="vert-center" scope="col">Name</th>
                <th class="vert-center" scope="col">Artifact</th>
                <th class="vert-center" scope="col">Build Id</th>
              </tr>
              <tr *ngFor="let item of data.response.appDeployments">
                <td class="vert-center" scope="col">{{item.appName}}</td>
                <td class="vert-center" scope="col">{{item.artifact?.artifactUri}}</td>
                <td class="vert-center" scope="col">{{item.artifact?.buildId}}</td>
              </tr>
            </table>
          </div>
        </nb-tab>

        <nb-tab tabTitle="All Changes">
          <div class="table-responsive">
            <table class="table table-bordered">
              <tr class="bg-light">
                <th class="vert-center" scope="col">Resource Path</th>
                <th class="vert-center" scope="col">Resource Key</th>
                <th class="vert-center" scope="col">Change Type</th>
              </tr>
              <tr *ngFor="let item of data.response.changesApplied">
                <td class="vert-center" scope="col">
                  <div [innerHTML]="convert.toHtml(item.resourcePath) | safeHtml"></div>
                </td>
                <td class="vert-center" scope="col">{{item.resourceKey}}</td>
                <td class="vert-center bg-danger" scope="col" *ngIf="item.type=='Destruction'">{{item.type}}</td>
                <td class="vert-center bg-warning" scope="col" *ngIf="item.type=='Modifications'">{{item.type}}</td>
                <td class="vert-center bg-success" scope="col" *ngIf="item.type=='Creation'">{{item.type}}</td>
              </tr>
            </table>
          </div>
        </nb-tab>
        <nb-tab *ngIf="data.overrideBuildSteps.length > 0" tabTitle="Steps Executed">
          <div style="text-align: center;" class="table-responsive">
            <nb-list nbInfiniteList [threshold]="500">
              <nb-list-item *ngFor="let overrideBuildSteps of data.overrideBuildSteps">
                {{overrideBuildSteps}}
              </nb-list-item>
            </nb-list>
          </div>
        </nb-tab>
      </nb-tabset>
    </nb-card-body>
  </nb-card>
</ng-template>


<ng-template #deploymentUI let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>Deployment</nb-card-header>

    <nb-card-body>
      <div style="background: rgba(255, 255, 255, 0.8);min-width:420px;padding:inherit;" class="row">
        <div class="row" style="padding-bottom:inherit;">
          <div class="col-sm-6 cc-key" style="display:flex;align-items: center;width:140px;">Resource</div>
          <div class="col-sm-6" style="display:flex;align-items: center;width:140px;">
            <nb-select
              [(ngModel)]="resourceMap"
              name="resourceMap"
              id="resourceMap"
              size="small"
              fullWidth
              multiple
              placeholder="Please select"
            >
              <nb-option-group title="Applications" value="Applications">
                <nb-option
                  #applicationNames
                  *ngFor="let apps of applicationNameList"
                  value="application:{{ apps }}"
                >
                  {{ apps }}
                </nb-option>
              </nb-option-group>

              <nb-option-group title="Cronjobs" value="Cronjobs">
                <nb-option
                  #applicationNames
                  *ngFor="let crons of cronjobNameList"
                  value="cronjob:{{ crons }}"
                >
                  {{ crons }}
                </nb-option>
              </nb-option-group>

              <nb-option-group title="Statefulsets" value="Statefulsets">
                <nb-option
                  #applicationNames
                  *ngFor="let sts of statefulSetNameList"
                  value="statefulsets:{{ sts }}"
                >
                  {{ sts }}
                </nb-option>
              </nb-option-group>
            </nb-select>
          </div>
        </div>
        <!--<div class="row" style="padding-bottom:inherit;" >
          <div class="col-sm-6 cc-key" style="display: flex;align-items: center;width:180px;">Cronjob  </div>
          <div class="col-sm-6">
            <app-resource-selector stackName="{{stackName}}" resourceTypeSelected="cronjob" (onResourceSelect)="cronSelected($event)"></app-resource-selector>
          </div>
        </div>
        <div class="row" style="padding-bottom:inherit;" >
          <div class="col-sm-6 cc-key" style="display: flex;align-items: center;width:180px;">Statefulset</div>
          <div class="col-sm-6">
            <app-resource-selector stackName="{{stackName}}" resourceTypeSelected="statefulsets" isClosed=true (onResourceSelect)="stsSelected($event)"></app-resource-selector>
          </div>
        </div> -->
      </div>
    </nb-card-body>
    <nb-card-footer>
      <button nbButton status=primary (click)="ref.close(data)"
              [disabled]="!resourceMap || resourceMap.length == 0" class="cc-margin-right">Confirm
      </button>
      <button nbButton status=basic (click)="ref.close()" class="cc-margin-right">Cancel</button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<ng-template #deploymentUIFull let-data let-ref="dialogRef">
  <nb-card [nbSpinner]="serverRequest">
    <nb-card-header>Deployment</nb-card-header>

    <nb-card-body>
      <div class="mb-3 mt-3">
        This will trigger the full deployment of your stack definition. Do you want to proceed?
      </div>
    </nb-card-body>
    <nb-card-footer>
      <button nbButton status=primary (click)="this.triggerFullRelease(ref)" class="cc-margin-right">Confirm
      </button>
      <button nbButton status=basic (click)="ref.close()" class="cc-margin-right">Cancel</button>
    </nb-card-footer>
  </nb-card>
</ng-template>
