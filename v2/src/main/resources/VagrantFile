# -*- mode: ruby -*-
# vi: set ft=ruby :

$script = <<-SCRIPT


### Install packages
apt-get install -y apt-transport-https
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
touch /etc/apt/sources.list.d/kubernetes.list
echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list

apt-get update
apt-get install -y unzip python3-pip libmysql-diff-perl python mysql-client
curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output /vagrant/get-pip.py
python /vagrant/get-pip.py
pip3 install jsonmerge requests
pip install requests

curl -o kubectl https://amazon-eks.s3.cn-north-1.amazonaws.com.cn/1.15.12/2020-11-02/bin/linux/amd64/kubectl
chmod +x ./kubectl
cp ./kubectl /usr/bin/kubectl
echo 'export PATH=$PATH:/usr/bin/kubectl' >> /home/vagrant/.profile

curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
chmod +x ./kind
mv ./kind /usr/bin/kind

TER_VER="0.12.24"
wget -q https://releases.hashicorp.com/terraform/${TER_VER}/terraform_${TER_VER}_linux_amd64.zip
unzip terraform_${TER_VER}_linux_amd64.zip
sudo mv terraform /usr/local/bin/
terraform -v

curl -s https://packagecloud.io/install/repositories/datawireio/telepresence/script.deb.sh | sudo bash
apt install --no-install-recommends -y telepresence

echo "Installed required packages"

### Get the IP address of VM
IPADDR=`ip -4 address show dev eth1 | grep inet | awk '{print $2}' | cut -f1 -d/`
echo $IPADDR > /vagrant/ip-address.txt



### Set up Kind Kubernetes

echo "kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  image: kindest/node:v1.15.12@sha256:67181f94f0b3072fb56509107b380e38c55e23bf60e6f052fbd8052d26052fb5
- role: worker
  image: kindest/node:v1.15.12@sha256:67181f94f0b3072fb56509107b380e38c55e23bf60e6f052fbd8052d26052fb5
networking:
  apiServerAddress: "0.0.0.0"
  apiServerPort: 6443" > clusterconfig.yaml

NODENAME=$(hostname -s)
kind create cluster --name cc-local --config clusterconfig.yaml
kind get clusters
sleep 10



### Setup CC tflocal

cd /vagrant/deisdeployer/capillary-cloud-tf/stacks/
ln -s /vagrant/cc-stack-crm cc-stack-crm
cd /vagrant/deisdeployer/capillary-cloud-tf
ln -s /vagrant/cc-stack-crm/database_views database_views
ln -s /vagrant/cc-stack-crm/schema schema
ln -s /vagrant/cc-stack-crm/seed_data seed_data
cd ~

export STACK_NAME='cc-stack-crm'
echo "export STACK_NAME=cc-stack-crm" >> /home/vagrant/.profile
cd /vagrant/deisdeployer
python3 /vagrant/deisdeployer/capillary-cloud-tf/tfaws/scripts/merge_overrides.py
mv /vagrant/deisdeployer/capillary-cloud-tf/tfaws/artifacts.json /vagrant/deisdeployer/capillary-cloud-tf/tflocal/artifacts.json

#Login to AWS ECR repo
chmod 777 /vagrant/dockerlogin.sh
echo "vagrant" | su -l vagrant bash -c /vagrant/dockerlogin.sh
bash -c /vagrant/dockerlogin.sh

mkdir ~/.aws
echo "[default]
region=us-west-1
output=json" > ~/.aws/config

echo "[default]
aws_secret_access_key = test1
aws_access_key_id = test2" > ~/.aws/credentials

mkdir -p /home/vagrant/.kube
kind export kubeconfig --name cc-local
kind get kubeconfig --name cc-local > /home/vagrant/.kube/config
cp /home/vagrant/.kube/config /vagrant/config
chown -R $(id -u vagrant):$(id -g vagrant) /home/vagrant/.kube

kubectl delete secret aws-ecr-token
kubectl create secret generic aws-ecr-token --from-file=.dockerconfigjson=/home/vagrant/./.docker/config.json --type=kubernetes.io/dockerconfigjson
kubectl patch sa default -p '{"imagePullSecrets":[{"name":"aws-ecr-token"}]}'
kubectl describe secret aws-ecr-token

### Terraform tflocal

#TODO: run telepresence via script
#telepresence --local-cluster

chown $(id -u vagrant):$(id -g vagrant) /vagrant/deisdeployer/capillary-cloud-tf
cd /vagrant/deisdeployer/capillary-cloud-tf/tflocal

terraform init

#terraform apply -target module.infra -auto-approve -no-color
#terraform apply -target module.application -auto-approve -no-color

SCRIPT



Vagrant.configure("2") do |config|
  config.trigger.before :up do |trigger|
    trigger.name = "Installing plugins"
    unless Vagrant.has_plugin?("vagrant-disksize")
    puts 'Installing vagrant-disksize Plugin...'
    system('vagrant plugin install vagrant-disksize')
    end

    unless Vagrant.has_plugin?("vagrant-vbguest")
    puts 'Installing vagrant-vbguest Plugin...'
    system('vagrant plugin install vagrant-vbguest')
    end
  end

  config.vm.network :forwarded_port, guest: 6443, host: 6443
  #config.disksize.size = '50GB'
  config.vm.provider "virtualbox" do |v|
    v.memory = 11000
    v.cpus = 4
  end

  config.vm.hostname = "cc-local"
  config.vm.box = "bento/ubuntu-20.04"
  config.vm.network "private_network", type: "dhcp"
  config.vm.provision "docker"
  config.vm.provision "shell", inline: $script
end