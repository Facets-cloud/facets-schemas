version: "3"

env:
  AWS_DEFAULT_REGION: ap-south-1
  ECHO_SERVER_COUNT: 5
  INGRESS_TESTING_HOSTED_ZONE: moduletesting.facetsdev.click
  INGRESS_TESTING_HOSTED_ZONE_ID: Z0667775XB8W7BJIM9S2
  KUBE_CONFIG_PATH:
    sh: echo $KUBECONFIG

dotenv:
  - ".aws.env"

# these variables are for using gotestsum in CI for report generation
vars:
  GO_TEST_CMD: "go test -v "
  GOTESTSUM_CMD: "gotestsum --format standard-verbose -- " # go test commands can be passed after this
  TEST_CMD:
    sh: |
      if command -v gotestsum >/dev/null 2>&1; then
          echo "{{.GOTESTSUM_CMD}}"
      else
          echo "{{.GO_TEST_CMD}}"
      fi

tasks:
  setup-echoserver: # sets up echo servers in cluster
    cmd: "{{.TEST_CMD}} -run TestSetupEchoServers"
    dir: setup
    requires:
      vars:
        - "KUBE_CONFIG_PATH"
        - "KUBECONFIG"

  destroy-echoserver:
    cmd: "{{.TEST_CMD}} -run TestDestroyEchoServers"
    dir: setup

  test-echoserver:
    cmds:
      - task: setup-echoserver
      - task: destroy-echoserver

  test-ingress-setup:
    cmd: "{{.TEST_CMD}} -timeout 30m -run TestIngressSetupPossible"
    dir: setup
    requires:
      vars:
        - "AWS_DEFAULT_REGION"
        - "AWS_ACCESS_KEY_ID"
        - "AWS_SECRET_ACCESS_KEY"
        - "KUBECONFIG"

  test-ingress-destroy:
    cmd: "{{.TEST_CMD}} -timeout 30m -run TestIngressDestroy"
    dir: setup

  test-ingress:
    cmds:
      - task: test-ingress-setup
      - task: test-ingress-destroy

  path-test:
    # deps:
    #   - setup-echoserver
    cmd: "{{.TEST_CMD}} -timeout 30m"
    dir: path_test

  domain-prefix-test:
    # deps:
    #   - setup-echoserver
    cmd: "{{.TEST_CMD}} -timeout 30m"
    dir: domain_prefix_test

  misc-test:
    cmd: "{{.TEST_CMD}} -timeout 30m"
    dir: misc_test

  setup:
    cmds:
      - task: setup-echoserver
      - task: test-ingress-setup

  destroy:
    cmds:
      - task: destroy-echoserver
      - task: test-ingress-destroy

  all-tests:
    cmds:
      - task: path-test
      - task: domain-prefix-test
      - task: misc-test

  default:
    cmds:
      - defer: { task: destroy }
      - task: setup
      - task: all-tests
    requires:
      vars:
        - "KUBECONFIG"

  #  ==== CI specific tasks - they assume being run in a ci env
  ci-mv-report:
    internal: true
    cmd: mv setup/$GOTESTSUM_JUNITFILE $LOGS_FOLDER/$(date +%s%N | cut -b1-13)-$GOTESTSUM_JUNITFILE
    summary: |
      moves the report generated in setup to another folder, timestamped to
      prevent that file from being overwritten

  ci-setup:
    ignore_error: true
    cmds:
      - task: setup-echoserver
      - task: ci-mv-report
      - task: test-ingress-setup
      - task: ci-mv-report

  ci-destroy:
    ignore_error: true
    cmds:
      - task: destroy-echoserver
      - task: ci-mv-report
      - task: test-ingress-destroy
      - task: ci-mv-report

  ci:
    cmds:
      - task: ci-setup
      # - defer: { task: destroy }
      - task: all-tests
